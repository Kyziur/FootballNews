@using Microsoft.AspNetCore.Identity
@inject SignInManager<User> SignInManager
@model FootballNews.WebApp.ViewModels.Article.ArticleModel

@{
    ViewBag.Title = Model.Title;
}
<div class="container d-flex justify-content-center flex-column border-bottom">
    <div class="mb-1">
        @if (Model.ImageAsBytes != null && Model.ImageAsBytes.Length > 0)
        {
            <img class="img-max-size" src="data:image/jpg;base64, @Convert.ToBase64String(Model.ImageAsBytes)" alt="@Model.ImageName">
        }
    </div>
    <div class="blog-main">
        <div class="pb-4 mb-4 border-bottom ">
            <h2 class="font-italic blog-post-title" id="articleTitle">
                @Model.Title
            </h2>
            <span class="blog-post-meta">
                @Model.CreatedDate.ToShortDateString()
                by <a href="#">@Model.Author</a>
            </span>
        </div>
        <div class="blog-post text-break">
            @Html.Raw(Model.Content)
        </div><!-- /.blog-post -->
    </div>
    <div class="my-3">
        <a class="btn btn-outline-success" asp-action="Index" asp-controller="Home">Back to articles</a>
    </div>
    <div class="mt-2">
        <h5>Comments</h5>
    </div>
</div>
@if (SignInManager.IsSignedIn(User))
{
    <div id="comments-container" class="mt-3">

    </div>
}
else
{
    <div>
        You must be logged in to comment article.
    </div>
}

@section Scripts {
    <script type="text/javascript" src="/js/dist/jquery-comments.js"></script>
    <script>
    function mapModelToComment(data){
        let model;
        if(Array.isArray(data)){
                model = data.map(comment => ({
                            id: comment.Id,
                            created: comment.CreatedDate,
                            content: comment.Text,
                            modified: '2015-10-01',
                            fullname: comment.FullName,
                            parent: comment.ParentId === undefined || comment.ParentId === null ? null : comment.ParentId
                        }));
        }else{
            model = {
                id: data.Id,
                created: data.CreatedDate,
                content: data.Text,
                modified: '2015-10-01',
                fullname: data.FullName,
                parent: data.ParentId === undefined || data.ParentId === null ? null : data.ParentId
            }
        }
           
        return model;
    }
    $('#comments-container').comments({
    enableDeleting: false,
    enableDeletingCommentWithReplies: false,
    enableReplying: true,
    enableUpvoting: false,
    refresh: function() {
            $('#comments-container').addClass('rendered');
    },
    getComments: function(success, error) {
        const articleTitle = document.getElementById('articleTitle').innerText;       
        $.ajax({
            type: 'get',
            url: `/api/comments/${articleTitle}`,
            success: function(data) {
                const comments = mapModelToComment(data);
                success(comments);
            },
            error: error
        });
    },
    postComment: function(commentJSON, success, error) {
        const articleTitle = document.getElementById('articleTitle').innerText;
        const comment = {
            articleTitle: articleTitle,
            text: commentJSON.content,
            parentId: commentJSON.parent
        };
                $.ajax({
                    type: 'post',
                    url: '/api/comments/',
                    contentType: "application/json",
                    data: JSON.stringify(comment),
                    success: function(result) {
                        const comments = mapModelToComment(result);
                        success(comments)
                    },
                    error: function(error){
                        console.log(error);
                    }
                });
            }
        
    });

    </script>
}